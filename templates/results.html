<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Prediction Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e9ecef;
        }
        .container {
            margin-top: 50px;
            margin-bottom: 50px;
            padding: 40px;
        }
        .text-primary { color: #007bff !important; }
        .text-secondary { color: #6c757d !important; }
        .bg-danger-light { background-color: #f8d7da; }
        .bg-success-light { background-color: #d4edda; }
        .list-group-item { border-radius: 0; }
        .list-group-item:first-child { border-top-left-radius: .25rem; border-top-right-radius: .25rem; }
        .list-group-item:last-child { border-bottom-left-radius: .25rem; border-bottom-right-radius: .25rem; }
        
        /* Better table styling */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
        }
        .dataframe {
            font-size: 0.9rem;
        }
        .dataframe thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .high-risk-table thead th {
            background-color: #dc3545;
            color: white;
        }
        .low-risk-table thead th {
            background-color: #28a745;
            color: white;
        }
        .dataframe tbody tr:hover {
            background-color: #f1f1f1;
        }
        .risk-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
        }
    </style>
</head>
<body>
    <div class="container bg-white shadow-lg rounded p-5">
        <h1 class="text-center text-primary mb-5"><i class="fas fa-search-dollar"></i> Attrition Analysis Dashboard</h1>

        <!-- Summary Statistics -->
        <div class="row mb-5">
            <div class="col-md-6">
                <div class="card border-danger h-100">
                    <div class="card-body text-center">
                        <h2 class="text-danger mb-0">{{ high_risk_count }}</h2>
                        <p class="text-muted mb-0">High Risk Employees</p>
                        <span class="badge bg-danger risk-badge mt-2">
                            <i class="fas fa-exclamation-triangle"></i> Immediate Attention Required
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success h-100">
                    <div class="card-body text-center">
                        <h2 class="text-success mb-0">{{ low_risk_count }}</h2>
                        <p class="text-muted mb-0">Low Risk Employees</p>
                        <span class="badge bg-success risk-badge mt-2">
                            <i class="fas fa-check-circle"></i> Stable & Engaged
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prediction Summary with Feature Breakdown -->
        <div class="card border-dark mb-5">
            <div class="card-header bg-dark text-white">
                <i class="fas fa-bullseye"></i> Individual Risk Assessment with Key Factors ({{ predictions|length }} Employees)
            </div>
            <div class="list-group list-group-flush">
                {% for p in predictions %}
                {% set prediction_class = 'bg-danger-light' if p.prediction == 'Yes' else 'bg-success-light' %}
                <li class="list-group-item {{ prediction_class }}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong style="font-size: 1.1rem;">{{ p.name }}</strong>
                        <div>
                            <span class="badge 
                                {% if p.prediction == 'Yes' %}bg-danger{% else %}bg-success{% endif %} 
                                p-2 rounded-pill shadow-sm me-2">
                                Risk: {{ p.prediction }}
                            </span>
                            <span class="badge bg-secondary p-2 rounded-pill">
                                {{ "{:.1f}".format(p.probability * 100) }}%
                            </span>
                        </div>
                    </div>
                    
                    <!-- Key Contributing Factors -->
                    {% if p.get('key_factors') and p.key_factors|length > 0 %}
                    <div class="mt-2 ms-3">
                        <small class="text-muted d-block mb-1">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Critical Risk Factors:</strong>
                        </small>
                        <div class="ms-3">
                            {% for factor in p.key_factors %}
                            <small class="d-block text-dark mb-1">
                                <i class="fas fa-caret-right text-danger"></i> 
                                <strong>{{ factor.feature }}:</strong> {{ factor.value }}
                                {% if factor.impact %}
                                <span class="badge badge-sm 
                                    {% if factor.impact == 'High' %}bg-danger{% elif factor.impact == 'Medium' %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                    {{ factor.impact }} Impact
                                </span>
                                {% endif %}
                            </small>
                            {% endfor %}
                        </div>
                    </div>
                    {% elif p.prediction == 'No' %}
                    <div class="mt-2 ms-3">
                        <small class="text-success">
                            <i class="fas fa-check-circle"></i> <em>No significant risk factors - employee is stable</em>
                        </small>
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            </div>
        </div>

        <!-- Data Visualizations -->
        <h2 class="text-secondary mb-4 border-bottom pb-2"><i class="fas fa-chart-area"></i> Model Explainability and Insights</h2>
        <p class="text-muted">The model's decision process is visualized below, showing feature importance and demographic patterns.</p>
        
        <div class="row g-4 mb-5">
            <!-- Feature Importance Plot -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-chart-bar"></i> Feature Contribution (SHAP-Style)
                    </div>
                    <div class="card-body text-center d-flex flex-column align-items-center justify-content-center">
                        {% if feature_plot %}
                            <img src="data:image/png;base64,{{ feature_plot }}" class="img-fluid" alt="Feature Importance Plot">
                        {% else %}
                            <p class="text-danger">No feature data available to plot.</p>
                        {% endif %}
                        <small class="text-muted d-block mt-2">
                            Factors that exerted the greatest influence on the predicted outcome.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Demographic Plot -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-chart-pie"></i> Demographic Breakdown
                    </div>
                    <div class="card-body text-center d-flex flex-column align-items-center justify-content-center">
                        {% if demo_plot %}
                            <img src="data:image/png;base64,{{ demo_plot }}" class="img-fluid" alt="Demographic Plot">
                        {% else %}
                            <p class="text-danger">No demographic data available to plot.</p>
                        {% endif %}
                        <small class="text-muted d-block mt-2">
                            Predicted attrition counts across job satisfaction levels.
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- HIGH RISK EMPLOYEES TABLE -->
        <h2 class="text-danger mt-5 mb-3 border-bottom border-danger pb-2">
            <i class="fas fa-exclamation-circle"></i> High Risk Employees ({{ high_risk_count }})
        </h2>
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>Priority Action Required:</strong> These employees have been identified as high attrition risk and should receive immediate HR attention.
        </div>
        
        {% if high_risk_count > 0 %}
        <div class="table-container shadow-sm rounded mb-5 high-risk-table">
            {{ high_risk_table | safe }}
        </div>
        {% else %}
        <div class="alert alert-success">
            <i class="fas fa-smile"></i> Great news! No high-risk employees identified in this batch.
        </div>
        {% endif %}

        <!-- LOW RISK EMPLOYEES TABLE -->
        <h2 class="text-success mt-5 mb-3 border-bottom border-success pb-2">
            <i class="fas fa-check-circle"></i> Low Risk Employees ({{ low_risk_count }})
        </h2>
        <div class="alert alert-success">
            <i class="fas fa-info-circle"></i> 
            <strong>Stable Workforce:</strong> These employees show low attrition risk and demonstrate good engagement levels.
        </div>
        
        {% if low_risk_count > 0 %}
        <div class="table-container shadow-sm rounded mb-5 low-risk-table">
            {{ low_risk_table | safe }}
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation"></i> No low-risk employees in this dataset. Consider investigating overall workplace conditions.
        </div>
        {% endif %}
        
        <div class="text-center mt-5">
            <a href="{{ url_for('predict') }}" class="btn btn-secondary btn-lg"><i class="fas fa-redo"></i> Run New Analysis</a>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg ms-3"><i class="fas fa-home"></i> Back to Home</a>
        </div>
    </div>
</body>
</html>